import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.58.0";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    const { sessionId } = await req.json();

    if (!sessionId) {
      throw new Error('Session ID is required');
    }

    console.log(`Starting strategic aggregation for session: ${sessionId}`);

    // Authenticate: support both frontend calls (with Authorization header) and service-to-service calls (without header)
    const authHeader = req.headers.get('Authorization');
    let userId: string;

    if (authHeader) {
      // Called from frontend with user token
      const token = authHeader.replace('Bearer ', '');
      const { data: { user }, error: authError } = await supabase.auth.getUser(token);
      if (authError || !user) {
        throw new Error('Unauthorized');
      }
      userId = user.id;
    } else {
      // Called from another edge function (process-analysis-queue) - get user_id from session
      const { data: sessionData, error: sessionError } = await supabase
        .from('analysis_sessions')
        .select('user_id')
        .eq('id', sessionId)
        .single();

      if (sessionError || !sessionData) {
        throw new Error('Session not found');
      }
      userId = sessionData.user_id;
      console.log(`Service-to-service call for user: ${userId}`);
    }

    // Fetch the session
    const { data: session, error: sessionError } = await supabase
      .from('analysis_sessions')
      .select('*')
      .eq('id', sessionId)
      .eq('user_id', userId)
      .single();

    if (sessionError || !session) {
      throw new Error('Session not found');
    }

    // Fetch all individual analysis results
    const { data: individualResults, error: resultsError } = await supabase
      .from('analysis_results')
      .select('*')
      .in('document_id', session.document_ids);

    if (resultsError) {
      throw new Error('Failed to fetch analysis results');
    }

    // Fetch document details
    const { data: documents, error: docsError } = await supabase
      .from('documents')
      .select('id, title, file_name')
      .in('id', session.document_ids);

    if (docsError) {
      throw new Error('Failed to fetch documents');
    }

    console.log(`Found ${individualResults.length} individual analyses for ${documents.length} documents`);

    // Prepare the comprehensive prompt for strategic aggregation
    const strategicPromptTemplate = `
Du √§r en expert p√• strategisk policyanalys och ska skapa en omfattande strategisk j√§mf√∂relseanalys.

ANALYSTYP: Strategisk J√§mf√∂relseanalys

M√ÖL: 
Identifiera l√•ngsiktiga m√•l och strategiska prioriteringar genom att analysera ALLA dokument tillsammans. 
Skapa en samlad strategisk √∂versikt som visar m√∂nster, synergier och gap mellan dokumenten.

INSTRUKTIONER:
1. **Strategisk √ñversikt**: Ge en omfattande sammanfattning (minst 200 ord) som visar:
   - Den samlade riktningen i alla dokument
   - Hur dokumenten kompletterar och f√∂rst√§rker varandra
   - √ñvergripande m√•lbilder och visioner
   - Kopplingar till nationella strategier, EU-agendor och Agenda 2030

2. **Gemensamma Fokusomr√•den**: Identifiera 5-7 huvudsakliga tematiska omr√•den som g√•r igen:
   - F√∂r varje omr√•de: ge en detaljerad beskrivning (minst 50 ord)
   - Lista vilka specifika dokument som tar upp omr√•det (med dokumentnamn)
   - Beskriv hur olika dokument belyser omr√•det ur olika perspektiv
   Exempel p√• omr√•den: gr√∂n omst√§llning, digitalisering, kompetensf√∂rs√∂rjning, inkludering, samverkan, resiliens

3. **Strategisk M√•lkarta**: Skapa en strukturerad lista med format:
   **Tema** ‚Üí Konkreta m√•l ‚Üí M√§tbara indikatorer
   
   F√∂r varje tema:
   - Lista 2-4 konkreta m√•l
   - Ge 2-3 f√∂reslagna indikatorer f√∂r uppf√∂ljning
   - Ange vilka dokument m√•len kommer ifr√•n
   
   Exempel:
   **Gr√∂n omst√§llning** ‚Üí Klimatneutralitet/utsl√§ppsminskning ‚Üí utsl√§pp per capita, andel f√∂rnybar energi (üìÑ RUS, üìÑ Nationell strategi)

4. **Gap-Analys**: Skapa en FAKTISK TABELL i markdown-format:
   
   | Omr√•de | Lokal kommunniv√• | Regional/Nationell/EU-niv√• | Identifierat gap |
   |--------|------------------|----------------------------|------------------|
   | [exempel: Klimat & energi] | [beskriv lokal niv√• fr√•n dokumenten] | [beskriv regional/nationell niv√• fr√•n dokumenten] | [beskriv konkreta gap: kapacitet, finansiering, kompetens, etc.] |
   
   Skapa minst 5-7 rader med konkreta gap baserade p√• dokumentens inneh√•ll.
   Var specifik om vilka typer av gap det √§r (genomf√∂randegap, resursgap, kompetensgap, etc.)

5. **Rekommenderade Fokusomr√•den f√∂r GR**: Lista 3-5 prioriterade fokusomr√•den med f√∂ljande struktur f√∂r varje:
   
   **[Nummer]. [Tydlig rubrik]** ‚Äì [kort beskrivning av vad det handlar om]
   
   [L√§ngre f√∂rklaring (minst 100 ord per rekommendation) som inkluderar:]
   - Varf√∂r detta √§r viktigt (med dokumentreferens, t.ex. üìÑ Dokumentnamn)
   - Konkreta f√∂rslag p√• √•tg√§rder och initiativ
   - Vilka akt√∂rer som b√∂r involveras
   - Koppling till identifierade gap
   - F√∂rv√§ntade resultat/effekter

OUTPUTFORMAT:
Din analys M√ÖSTE f√∂lja denna markdown-struktur:

## Strategisk √ñversikt
[Omfattande √∂versiktstext p√• minst 200 ord]

## Gemensamma Fokusomr√•den
**[Omr√•de 1]** ‚Äì [Detaljerad beskrivning med dokumentreferenser]
üìÑ [Dokumentnamn], üìÑ [Dokumentnamn]

**[Omr√•de 2]** ‚Äì [Detaljerad beskrivning med dokumentreferenser]
...

## Strategisk M√•lkarta (teman ‚Üí m√•l ‚Üí indikatorer)
**[Tema 1]** ‚Üí [M√•l] ‚Üí [Indikatorer]
üìÑ [Dokumentreferens]

**[Tema 2]** ‚Üí [M√•l] ‚Üí [Indikatorer]
...

## Gap-Analys
| Omr√•de | Lokal kommunniv√• | Regional/Nationell/EU-niv√• | Identifierat gap |
|--------|------------------|----------------------------|------------------|
| [Omr√•de 1] | [Beskrivning] | [Beskrivning] | [Konkret gap] |
| [Omr√•de 2] | [Beskrivning] | [Beskrivning] | [Konkret gap] |
...

## Rekommenderade Fokusomr√•den f√∂r GR (3‚Äì5)
**1. [Rubrik]** ‚Äì [Kort beskrivning]

[L√§ngre f√∂rklaring med varf√∂r, vad, hur, vilka, och dokumentreferenser]
üìÑ [Dokumentnamn], üìÑ [Dokumentnamn]

**2. [Rubrik]** ‚Äì [Kort beskrivning]
...

---

KRITISKA KVALITETSKRAV:
‚úÖ Varje sektion ska vara omfattande och detaljerad (inte korta punktlistor)
‚úÖ Gap-analysen M√ÖSTE vara en faktisk markdown-tabell med |
‚úÖ Alla p√•st√•enden ska referera till specifika dokument med üìÑ emoji
‚úÖ Rekommendationerna ska vara handlingsbara med konkreta √•tg√§rdsf√∂rslag
‚úÖ Texten ska vara professionell, tv√§rsektoriell och strategiskt t√§nkande
‚úÖ Totalt minst 1500 ord f√∂r hela analysen
‚úÖ Anv√§nd dokumentens faktiska inneh√•ll, inte generiska formuleringar
`;

    // Build the comprehensive context from all individual analyses
    let analysisContext = "INDIVIDUELLA DOKUMENTANALYSER:\n\n";
    
    for (const result of individualResults) {
      const doc = documents.find(d => d.id === result.document_id);
      analysisContext += `### Dokument: ${doc?.title || doc?.file_name}\n\n`;
      
      if (result.summary) {
        analysisContext += `**Sammanfattning:**\n${result.summary}\n\n`;
      }
      
      if (result.extracted_data?.markdown_output) {
        analysisContext += `**Fullst√§ndig analys:**\n${result.extracted_data.markdown_output}\n\n`;
      }
      
      if (result.keywords && result.keywords.length > 0) {
        analysisContext += `**Nyckelord:** ${result.keywords.join(', ')}\n\n`;
      }
      
      analysisContext += "---\n\n";
    }

    // Add custom prompt if provided
    if (session.custom_prompt) {
      analysisContext += `\n\nANV√ÑNDAR-SPECIFIKA INSTRUKTIONER:\n${session.custom_prompt}\n\n`;
    }

    // Call Lovable AI with tool calling for structured output
    const LOVABLE_API_KEY = Deno.env.get('LOVABLE_API_KEY');
    if (!LOVABLE_API_KEY) {
      throw new Error('LOVABLE_API_KEY is not configured');
    }

    console.log('Calling Lovable AI for strategic aggregation...');

    const aiResponse = await fetch('https://ai.gateway.lovable.dev/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${LOVABLE_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'google/gemini-2.5-flash',
        messages: [
          {
            role: 'system',
            content: strategicPromptTemplate
          },
          {
            role: 'user',
            content: `Analysera f√∂ljande dokument och skapa en strategisk j√§mf√∂relseanalys:\n\n${analysisContext}`
          }
        ],
        tools: [
          {
            type: 'function',
            function: {
              name: 'create_strategic_analysis',
              description: 'Skapa en omfattande strategisk j√§mf√∂relseanalys med alla obligatoriska sektioner',
              parameters: {
                type: 'object',
                properties: {
                  strategic_overview: {
                    type: 'string',
                    description: 'OMFATTANDE strategisk √∂versikt (minst 200 ord) som beskriver den samlade riktningen i alla dokument, hur de kompletterar varandra, √∂vergripande m√•lbilder och kopplingar till nationella/EU-strategier'
                  },
                  common_focus_areas: {
                    type: 'array',
                    items: {
                      type: 'object',
                      properties: {
                        area: { 
                          type: 'string',
                          description: 'Namnet p√• fokusomr√•det (t.ex. "Gr√∂n omst√§llning & elektrifiering")'
                        },
                        description: { 
                          type: 'string',
                          description: 'DETALJERAD beskrivning av omr√•det (minst 50 ord) som f√∂rklarar hur olika dokument belyser det'
                        },
                        documents: { 
                          type: 'array', 
                          items: { type: 'string' },
                          description: 'Lista med dokumentnamn som tar upp detta omr√•de'
                        }
                      },
                      required: ['area', 'description', 'documents']
                    },
                    description: '5-7 huvudsakliga gemensamma fokusomr√•den med detaljerade beskrivningar'
                  },
                  strategic_goals_map: {
                    type: 'string',
                    description: 'Strategisk m√•lkarta i markdown-format med struktur: **Tema** ‚Üí M√•l ‚Üí Indikatorer. Inkludera dokumentreferenser med üìÑ emoji. Minst 5-7 olika teman.'
                  },
                  gap_analysis: {
                    type: 'string',
                    description: 'FAKTISK markdown-tabell med | som avgr√§nsare. Format: | Omr√•de | Lokal kommunniv√• | Regional/Nationell/EU-niv√• | Identifierat gap |. Minst 5-7 rader med konkreta, detaljerade gap baserade p√• dokumentens faktiska inneh√•ll. Var specifik om gap-typer (genomf√∂randegap, resursgap, kompetensgap, etc.)'
                  },
                  recommended_focus_areas: {
                    type: 'array',
                    items: {
                      type: 'object',
                      properties: {
                        title: { 
                          type: 'string',
                          description: 'Tydlig, handlingsbar rubrik f√∂r rekommendationen'
                        },
                        description: { 
                          type: 'string',
                          description: 'OMFATTANDE beskrivning (minst 100 ord) som inkluderar: varf√∂r det √§r viktigt, konkreta √•tg√§rdsf√∂rslag, vilka akt√∂rer som b√∂r involveras, koppling till identifierade gap, f√∂rv√§ntade resultat'
                        },
                        motivation: { 
                          type: 'string',
                          description: 'Dokumentreferenser som st√∂djer denna rekommendation (med üìÑ emoji)'
                        }
                      },
                      required: ['title', 'description', 'motivation']
                    },
                    description: '3-5 prioriterade, detaljerade och handlingsbara fokusomr√•den f√∂r G√∂teborgsregionen'
                  },
                  full_markdown_output: {
                    type: 'string',
                    description: 'KOMPLETT, PROFESSIONELL analys i markdown-format enligt exakt den mall som specificerats. M√ÖSTE inneh√•lla ALLA sektioner: ## Strategisk √ñversikt, ## Gemensamma Fokusomr√•den, ## Strategisk M√•lkarta, ## Gap-Analys (med faktisk tabell), ## Rekommenderade Fokusomr√•den. Totalt minst 1500 ord. Anv√§nd üìÑ emoji f√∂r dokumentreferenser genomg√•ende.'
                  }
                },
                required: ['strategic_overview', 'common_focus_areas', 'strategic_goals_map', 'gap_analysis', 'recommended_focus_areas', 'full_markdown_output'],
                additionalProperties: false
              }
            }
          }
        ],
        tool_choice: {
          type: 'function',
          function: { name: 'create_strategic_analysis' }
        }
      }),
    });

    if (!aiResponse.ok) {
      const errorText = await aiResponse.text();
      console.error('AI API error:', aiResponse.status, errorText);
      throw new Error(`AI API error: ${aiResponse.status}`);
    }

    const aiData = await aiResponse.json();
    console.log('AI response received');

    // Extract structured output from tool call
    let aggregatedAnalysis;
    if (aiData.choices?.[0]?.message?.tool_calls?.[0]) {
      const toolCall = aiData.choices[0].message.tool_calls[0];
      aggregatedAnalysis = JSON.parse(toolCall.function.arguments);
    } else {
      throw new Error('No structured output from AI');
    }

    // Create the final result structure
    const finalResult = {
      type: 'strategic_aggregation',
      analysis_type: session.analysis_type,
      document_count: documents.length,
      documents: documents.map(d => ({
        id: d.id,
        title: d.title,
        file_name: d.file_name
      })),
      strategic_overview: aggregatedAnalysis.strategic_overview,
      common_focus_areas: aggregatedAnalysis.common_focus_areas,
      strategic_goals_map: aggregatedAnalysis.strategic_goals_map,
      gap_analysis: aggregatedAnalysis.gap_analysis,
      recommended_focus_areas: aggregatedAnalysis.recommended_focus_areas,
      full_markdown_output: aggregatedAnalysis.full_markdown_output,
      individual_results: individualResults.map(r => ({
        document_id: r.document_id,
        summary: r.summary,
        keywords: r.keywords
      })),
      completed_at: new Date().toISOString()
    };

    // Update the session with the aggregated result
    const { error: updateError } = await supabase
      .from('analysis_sessions')
      .update({
        analysis_result: finalResult,
        status: 'completed',
        completed_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      })
      .eq('id', sessionId);

    if (updateError) {
      throw new Error('Failed to update session: ' + updateError.message);
    }

    console.log(`Strategic aggregation completed for session: ${sessionId}`);

    return new Response(
      JSON.stringify({
        success: true,
        sessionId,
        result: finalResult
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      }
    );

  } catch (error) {
    console.error('Error in aggregate-strategic-analysis:', error);
    return new Response(
      JSON.stringify({
        error: error instanceof Error ? error.message : 'Unknown error'
      }),
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      }
    );
  }
});
